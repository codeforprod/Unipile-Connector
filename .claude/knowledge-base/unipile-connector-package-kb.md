# Knowledge Base: Unipile Connector NPM Package

> Generated by R&D Pipeline on 2026-01-17
> Task Slug: unipile-connector-package

## Executive Summary

Build a universal NPM package for Unipile integration that provides email and social network messaging capabilities. The package will be used by Holocron v2 and CallAiris (AIRIS) systems, consolidating all existing Holocron Legacy Unipile features into a reusable, well-typed NestJS module.

## Research Findings

### Unipile API Documentation Analysis

**Authentication:**
- Method: Access Token + DSN (Data Source Name)
- Headers: `X-API-KEY: {YOUR_ACCESS_TOKEN}`, `Accept: application/json`
- Base URL: `https://{subdomain}.unipile.com:{port}/api/v1/`
- SDK: `unipile-node-sdk` (v1.9.3, requires Node.js 18+)

**Supported Providers:**

| Category | Providers |
|----------|-----------|
| Messaging | LinkedIn, WhatsApp, Instagram, Messenger, Telegram, Twitter/X, Slack |
| Email | Gmail (OAuth), Outlook (OAuth), iCloud, Exchange, Generic IMAP |

**Account Status Values:**
- `OK` - Connected and operational
- `CONNECTING` - Connection in progress
- `CREDENTIALS` - Credential issue
- `PERMISSIONS` - Permission issue
- `ERROR` - General error
- `STOPPED` - Account stopped

### Holocron Legacy Codebase Analysis

**Existing Integration Files:**
```
src/external/unipile/
├── unipile.service.ts      # Main API service layer
├── unipile.types.ts        # Type definitions
├── unipile.fetch.ts        # HTTP request wrapper
└── unipile.helpers.ts      # Helper utilities
```

**Implemented Features:**
1. **LinkedIn Sales Navigator Integration**
   - Company search with 15+ filters (industry, location, headcount, revenue, etc.)
   - Employee/People search (role, location, company filters)
   - Company profile retrieval (full details)
   - Person profile retrieval (experience, headline, location)
   - Search parameter enumeration (for dynamic dropdowns)

2. **Data Persistence Layer**
   - Save company data to MongoDB via `saveCompanyDataFromUnipile()`
   - Save person data to MongoDB via `savePersonDataFromUnipile()`
   - Location enrichment with progressive matching

3. **Advanced Features**
   - Rate limit detection with exponential backoff (5min base, max 2h)
   - Multi-tenant account isolation via `unipileAccountId`
   - Redis caching for location counts (5min TTL)
   - Cursor-based pagination
   - Error categorization (timeout, connection, rate_limit, unknown)

**Environment Variables Used:**
```bash
UNIPILE_DSN=api6.unipile.com:13624
UNIPILE_API_KEY=xxx
UNIPILE_USE_HTTP=true  # optional
```

### EventForge Package Structure Analysis

**Monorepo Layout (pnpm workspaces + Turborepo):**
```
packages/
├── core/           # Framework-agnostic interfaces and services
├── nestjs/         # NestJS Dynamic Module integration
├── adapter-*/      # Database adapters (TypeORM, Mongoose)
└── publisher-*/    # Message publishers (RabbitMQ)
```

**Key Patterns:**
1. **Barrel Exports** - Clean public API via index.ts
2. **Dynamic Modules** - `forRoot()` / `forRootAsync()` pattern
3. **Peer Dependencies** - External frameworks as peer deps
4. **Workspace Dependencies** - Internal packages via `workspace:*`
5. **TypeScript Project References** - Build optimization
6. **80% Test Coverage** - Enforced via Jest

## Requirements

### Functional Requirements

1. **Email Operations**
   - Send emails with HTML/plain text body
   - Support attachments (Buffer-based)
   - Reply threading via `reply_to`
   - CC/BCC recipients
   - Email tracking (opens, link clicks)
   - List/retrieve/delete emails
   - Folder management

2. **Messaging Operations**
   - Start new chats on all supported platforms
   - Send messages to existing chats
   - Attachment support
   - LinkedIn-specific: InMail, Sales Navigator, Recruiter API
   - Get chat history with pagination
   - List attendees/contacts

3. **Account Management**
   - Connect accounts (OAuth, credentials, cookies, QR codes)
   - Handle 2FA/checkpoints (OTP, in-app validation, CAPTCHA)
   - Reconnect disconnected accounts
   - Monitor account status

4. **Webhook Integration**
   - Create/delete webhooks
   - Sources: messaging, email, email_tracking, account_status
   - Events: message_received, mail_sent, mail_opened, etc.
   - Custom headers and field mapping

5. **LinkedIn Sales Navigator (from Holocron Legacy)**
   - Company search with all filters
   - Employee search with filters
   - Company profile enrichment
   - Person profile enrichment
   - Search parameter enumeration

### Technical Requirements

1. **Package Architecture**
   - Monorepo with pnpm workspaces
   - Core package (no framework dependencies)
   - NestJS integration module
   - TypeScript with strict mode
   - Full type definitions

2. **Configuration**
   - Environment-based configuration
   - Dynamic module options
   - Multi-tenant account support
   - Flexible provider configuration

3. **Error Handling**
   - Categorized errors (timeout, connection, rate_limit, unknown)
   - Automatic retry with exponential backoff
   - Rate limit detection from headers
   - Graceful degradation with fallbacks

4. **Testing**
   - Jest with ts-jest
   - 80% coverage threshold
   - Unit tests colocated with source
   - Integration test examples

5. **Documentation**
   - README with quick start
   - JSDoc on all public APIs
   - Configuration reference
   - Migration guide from Holocron Legacy

## Architecture & Design

### Recommended Package Structure

```
@unipile/
├── core/                    # @unipile/core
│   ├── src/
│   │   ├── interfaces/      # Type definitions
│   │   │   ├── email.interface.ts
│   │   │   ├── messaging.interface.ts
│   │   │   ├── account.interface.ts
│   │   │   ├── webhook.interface.ts
│   │   │   ├── linkedin.interface.ts
│   │   │   └── index.ts
│   │   ├── services/        # Core services
│   │   │   ├── email.service.ts
│   │   │   ├── messaging.service.ts
│   │   │   ├── account.service.ts
│   │   │   ├── webhook.service.ts
│   │   │   ├── linkedin.service.ts
│   │   │   └── index.ts
│   │   ├── errors/          # Custom error classes
│   │   │   ├── unipile.error.ts
│   │   │   ├── rate-limit.error.ts
│   │   │   └── index.ts
│   │   ├── config/          # Configuration
│   │   │   ├── unipile.config.ts
│   │   │   └── index.ts
│   │   ├── http/            # HTTP client wrapper
│   │   │   ├── unipile-http.client.ts
│   │   │   └── index.ts
│   │   └── index.ts
│   └── package.json
│
├── nestjs/                  # @unipile/nestjs
│   ├── src/
│   │   ├── unipile.module.ts        # Dynamic Module
│   │   ├── unipile.interfaces.ts    # Module options
│   │   ├── unipile.constants.ts     # Injection tokens
│   │   ├── decorators/              # Custom decorators
│   │   └── index.ts
│   └── package.json
│
└── package.json             # Root workspace
```

### Public API Design

**Core Services:**

```typescript
// Email Service
interface IEmailService {
  send(input: SendEmailInput): Promise<EmailResponse>;
  getAll(params: GetEmailsParams): Promise<PaginatedResponse<Email>>;
  getOne(emailId: string): Promise<Email>;
  update(emailId: string, input: UpdateEmailInput): Promise<Email>;
  delete(emailId: string): Promise<void>;
  getAttachment(emailId: string, attachmentId: string): Promise<Buffer>;
  getFolders(accountId: string): Promise<Folder[]>;
}

// Messaging Service
interface IMessagingService {
  startChat(input: StartChatInput): Promise<Chat>;
  sendMessage(input: SendMessageInput): Promise<Message>;
  getChats(params: GetChatsParams): Promise<PaginatedResponse<Chat>>;
  getMessages(chatId: string, params?: PaginationParams): Promise<PaginatedResponse<Message>>;
  getAttendees(params: GetAttendeesParams): Promise<PaginatedResponse<Attendee>>;
}

// Account Service
interface IAccountService {
  getAll(): Promise<Account[]>;
  getOne(accountId: string): Promise<Account>;
  connect(input: ConnectAccountInput): Promise<ConnectResult>;
  reconnect(accountId: string): Promise<Account>;
  delete(accountId: string): Promise<void>;
  solveCheckpoint(input: CheckpointInput): Promise<Account>;
  createHostedAuthLink(input: HostedAuthInput): Promise<HostedAuthLink>;
}

// Webhook Service
interface IWebhookService {
  create(input: CreateWebhookInput): Promise<Webhook>;
  getAll(): Promise<Webhook[]>;
  delete(webhookId: string): Promise<void>;
}

// LinkedIn Service (from Holocron Legacy)
interface ILinkedInService {
  searchCompanies(accountId: string, filters: CompanySearchFilters): Promise<CompanySearchResult>;
  searchPeople(accountId: string, filters: PeopleSearchFilters): Promise<PeopleSearchResult>;
  getCompanyProfile(accountId: string, entityUrn: string): Promise<CompanyProfile>;
  getPersonProfile(accountId: string, identifier: string): Promise<PersonProfile>;
  getSearchParameters(type: ParameterType, keywords: string): Promise<SearchParameter[]>;
  sendInvitation(input: InvitationInput): Promise<void>;
}
```

**NestJS Module:**

```typescript
@Module({})
export class UnipileModule {
  static forRoot(options: UnipileModuleOptions): DynamicModule;
  static forRootAsync(options: UnipileModuleAsyncOptions): DynamicModule;
}

// Usage
@Module({
  imports: [
    UnipileModule.forRoot({
      dsn: process.env.UNIPILE_DSN,
      apiKey: process.env.UNIPILE_API_KEY,
      useHttp: false,
      rateLimitConfig: {
        baseCooldownMs: 300000, // 5 minutes
        maxCooldownMs: 7200000, // 2 hours
      },
    }),
  ],
})
export class AppModule {}
```

### Integration Points

**With Holocron v2:**
- Replace `src/external/unipile/` with `@unipile/nestjs` import
- Migrate type definitions to use package types
- Update environment variable names if needed

**With CallAiris (AIRIS):**
- Import `@unipile/nestjs` in relevant modules
- Configure for email/messaging use cases
- Set up webhooks for real-time notifications

### File Migration Mapping

| Holocron Legacy | New Package |
|-----------------|-------------|
| `unipile.service.ts` | `@unipile/core/services/linkedin.service.ts` |
| `unipile.types.ts` | `@unipile/core/interfaces/*.interface.ts` |
| `unipile.fetch.ts` | `@unipile/core/http/unipile-http.client.ts` |
| `unipile.helpers.ts` | `@unipile/core/utils/` |

## Implementation Guide

### Step-by-Step Plan

1. **Initialize Monorepo** (Day 1)
   - Set up pnpm workspace
   - Configure Turborepo
   - Add shared configs (TypeScript, ESLint, Jest, Prettier)
   - Create package directories

2. **Build Core Package** (Days 2-4)
   - Port HTTP client with error handling
   - Implement all service interfaces
   - Port Holocron Legacy LinkedIn services
   - Add comprehensive type definitions
   - Write unit tests

3. **Build NestJS Module** (Days 5-6)
   - Create dynamic module with forRoot/forRootAsync
   - Add injection tokens and providers
   - Implement lifecycle service for webhook handling
   - Write integration tests

4. **Documentation & Publishing** (Day 7)
   - Write comprehensive README
   - Add JSDoc to all public APIs
   - Configure changesets
   - Publish to NPM

### Code Patterns to Implement

**HTTP Client Pattern (from Holocron Legacy):**
```typescript
async function unipileFetch<T>(
  url: string,
  options: RequestInit,
  fallback: T,
): Promise<T | { error: UnipileError }> {
  try {
    const response = await fetch(url, {
      ...options,
      headers: {
        'accept': 'application/json',
        'X-API-KEY': apiKey,
        ...options.headers,
      },
    });

    if (!response.ok) {
      if (response.status === 429) {
        const retryAfter = parseRetryAfterSeconds(response.headers);
        return {
          error: {
            type: 'rate_limit',
            message: 'Rate limit exceeded',
            retryable: true,
            retryAfterSeconds: retryAfter,
          },
        };
      }
      throw new Error(`HTTP ${response.status}`);
    }

    return response.json();
  } catch (error) {
    return { error: categorizeError(error) };
  }
}
```

**Rate Limit Handling Pattern:**
```typescript
function calculateCooldownDuration(hitCount: number): number {
  const baseCooldownMs = 5 * 60 * 1000; // 5 minutes
  const maxCooldownMs = 2 * 60 * 60 * 1000; // 2 hours
  return Math.min(baseCooldownMs * Math.pow(2, hitCount - 1), maxCooldownMs);
}
```

### API References

**Email Endpoints:**
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/v1/emails` | List all emails |
| POST | `/api/v1/emails` | Send an email |
| GET | `/api/v1/emails/{id}` | Retrieve specific email |
| PUT | `/api/v1/emails/{id}` | Update email |
| DELETE | `/api/v1/emails/{id}` | Delete an email |

**Messaging Endpoints:**
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/v1/chats` | List all chats |
| POST | `/api/v1/chats` | Start new chat |
| GET | `/api/v1/chats/{id}/messages` | List messages |
| POST | `/api/v1/chats/{id}/messages` | Send message |

**LinkedIn Endpoints (from Holocron Legacy):**
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/v1/linkedin/search/parameters` | Get search parameters |
| POST | `/api/v1/linkedin/search` | Search companies/people |
| GET | `/api/v1/linkedin/company/{urn}` | Get company profile |
| GET | `/api/v1/users/{id}` | Get person profile |

## Dependencies

### Required Packages

**Core Package:**
```json
{
  "dependencies": {
    "reflect-metadata": "^0.2.1"
  },
  "devDependencies": {
    "@types/node": "^20.10.0",
    "typescript": "^5.3.3",
    "jest": "^29.7.0",
    "ts-jest": "^29.1.1"
  }
}
```

**NestJS Package:**
```json
{
  "dependencies": {
    "@unipile/core": "workspace:*"
  },
  "peerDependencies": {
    "@nestjs/common": "^10.0.0 || ^11.0.0",
    "@nestjs/core": "^10.0.0 || ^11.0.0",
    "reflect-metadata": "^0.2.0"
  }
}
```

### Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `UNIPILE_DSN` | Yes | Unipile API domain:port (e.g., `api6.unipile.com:13624`) |
| `UNIPILE_API_KEY` | Yes | API access token |
| `UNIPILE_USE_HTTP` | No | Use HTTP instead of HTTPS (default: false) |

### Configuration Changes

**Holocron v2 Migration:**
1. Remove `src/external/unipile/` directory
2. Install `@unipile/nestjs` package
3. Import `UnipileModule` in AppModule
4. Update service injections to use package providers

## Risks & Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| API breaking changes | Low | High | Pin to specific Unipile SDK version, add integration tests |
| Rate limit issues | Medium | Medium | Implement exponential backoff with per-account tracking |
| Type mismatches | Medium | Low | Use official SDK types where available, add validation |
| Multi-tenant conflicts | Low | High | Isolate accounts via accountId parameter |
| Webhook delivery failures | Medium | Medium | Implement retry mechanism, dead-letter queue |

## Acceptance Criteria

### Package Structure
- [ ] Monorepo initialized with pnpm workspaces
- [ ] Core package with all services implemented
- [ ] NestJS module with dynamic configuration
- [ ] TypeScript strict mode enabled
- [ ] 80% test coverage achieved

### Email Features
- [ ] Send email with attachments
- [ ] Reply threading works correctly
- [ ] Email tracking (opens, clicks) functional
- [ ] Folder management working

### Messaging Features
- [ ] Start chat on all platforms
- [ ] Send messages with attachments
- [ ] LinkedIn InMail/Sales Navigator support
- [ ] Pagination working

### LinkedIn Features (from Holocron Legacy)
- [ ] Company search with all filters migrated
- [ ] Employee search migrated
- [ ] Profile enrichment working
- [ ] Rate limiting implemented

### Account Management
- [ ] OAuth flow for email providers
- [ ] Credential auth for messaging platforms
- [ ] 2FA/checkpoint handling
- [ ] Account status monitoring

### Webhook Integration
- [ ] Create webhooks for all sources
- [ ] Receive real-time events
- [ ] Custom headers support

### Documentation
- [ ] README with installation and quick start
- [ ] JSDoc on all public APIs
- [ ] Configuration reference complete
- [ ] Migration guide for Holocron Legacy

### Publishing
- [ ] NPM packages published
- [ ] Changesets configured
- [ ] CI/CD pipeline working

---
*This Knowledge Base was generated by R&D Researcher and should be referenced during implementation.*
