# Knowledge Base: CI/CD Pipeline Implementation for Unipile-Connector

> Generated by R&D Pipeline on 2026-01-19
> Task Slug: cicd-pipeline-implementation

## Executive Summary

Implement a complete CI/CD pipeline for the Unipile-Connector monorepo based on the proven patterns from Event-Forge. The pipeline will include continuous integration (build, test, lint, typecheck) and automated release workflows using Changesets for versioning and NPM publishing.

## Research Findings

### Documentation Analysis

#### GitHub Actions Patterns (from Event-Forge)

Event-Forge uses a mature CI/CD implementation with these key patterns:

1. **Workflow Separation**: CI and Release are separate workflows
2. **Concurrency Control**: Smart cancellation for PRs, never for releases
3. **Security**: Minimal permissions, OIDC for trusted publishing
4. **Verification**: npm pack validation ensures dist/ files included

### Codebase Analysis

#### Event-Forge Workflow Files

| File | Purpose | Status |
|------|---------|--------|
| `ci.yml` | Build, test, lint, typecheck | Active |
| `release.yml` | Changesets versioning + NPM publish | Active |
| `npm-publish.yml` | Legacy manual publish | Superseded |
| `python-publish.yml` | PyPI publish | Not needed for Unipile |

#### ci.yml Complete Analysis

**Triggers:**
```yaml
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
```

**Concurrency:**
```yaml
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}
```

**Job Steps:**
1. Checkout with full history (`fetch-depth: 0`)
2. Setup pnpm v8.15.0
3. Setup Node.js 20 with pnpm cache
4. Install with frozen lockfile
5. Build all packages
6. Run typecheck
7. Run lint
8. Run tests
9. **Verify npm pack** - Critical validation step

**npm pack Verification Script:**
```bash
set -e
echo "Verifying npm pack for all packages..."

verify_package() {
  local pkg_name=$1
  local npm_name=$2

  echo "Checking $npm_name..."
  cd packages/$pkg_name

  tarball=$(pnpm pack 2>/dev/null | tail -1)

  if ! tar -tzf "$tarball" | grep -q "dist/.*\.js"; then
    echo "ERROR: $npm_name tarball does not contain dist/*.js files!"
    tar -tzf "$tarball"
    exit 1
  fi

  echo "✓ $npm_name tarball contains dist/ files"
  rm -f "$tarball"
  cd ../..
}

verify_package "core" "@unipile/core"
verify_package "nestjs" "@unipile/nestjs"

echo ""
echo "All packages verified successfully!"
```

#### release.yml Complete Analysis

**Triggers:**
```yaml
on:
  push:
    branches:
      - main
```

**Concurrency:**
```yaml
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false  # NEVER cancel releases
```

**Permissions:**
```yaml
permissions:
  contents: write       # Create releases, update CHANGELOG
  pull-requests: write  # Create version PRs
  id-token: write       # OIDC (if needed for future PyPI)
```

**Changesets Action Configuration:**
```yaml
- name: Create Release Pull Request or Publish
  id: changesets
  uses: changesets/action@v1
  with:
    version: pnpm run version-packages
    publish: pnpm run ci:publish
    commit: 'chore(release): version packages'
    title: 'chore(release): version packages'
    createGithubReleases: true
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

### External References

#### Changesets Configuration (Event-Forge)

**File:** `.changeset/config.json`
```json
{
  "$schema": "https://unpkg.com/@changesets/config@3.0.0/schema.json",
  "changelog": "@changesets/cli/changelog",
  "commit": false,
  "fixed": [],
  "linked": [["@prodforcode/event-forge-*"]],
  "access": "public",
  "baseBranch": "main",
  "updateInternalDependencies": "patch",
  "ignore": []
}
```

**Adaptation for Unipile:**
```json
{
  "$schema": "https://unpkg.com/@changesets/config@3.0.0/schema.json",
  "changelog": "@changesets/cli/changelog",
  "commit": false,
  "fixed": [],
  "linked": [["@unipile/*"]],
  "access": "public",
  "baseBranch": "main",
  "updateInternalDependencies": "patch",
  "ignore": []
}
```

#### Turbo Configuration (Event-Forge)

**File:** `turbo.json`
```json
{
  "$schema": "https://turbo.build/schema.json",
  "tasks": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**"]
    },
    "test": {
      "dependsOn": ["build"],
      "outputs": ["coverage/**"]
    },
    "typecheck": {
      "dependsOn": ["^build"]
    },
    "lint": {
      "dependsOn": []
    }
  }
}
```

## Requirements

### Functional Requirements

#### CI Workflow Requirements

| ID | Requirement | Priority |
|----|-------------|----------|
| CI-FR-001 | Run on all pull requests to main branch | High |
| CI-FR-002 | Run on all direct pushes to main branch | High |
| CI-FR-003 | Build all packages in correct dependency order | High |
| CI-FR-004 | Run TypeScript type checking (`tsc --noEmit`) | High |
| CI-FR-005 | Run ESLint code quality checks | High |
| CI-FR-006 | Run Jest test suite | High |
| CI-FR-007 | Verify npm pack includes compiled dist/ files | High |
| CI-FR-008 | Cancel redundant PR workflow runs | Medium |
| CI-FR-009 | Use pnpm with frozen lockfile for deterministic builds | High |

#### Release Workflow Requirements

| ID | Requirement | Priority |
|----|-------------|----------|
| REL-FR-001 | Trigger only on main branch pushes | High |
| REL-FR-002 | Build packages before publishing | High |
| REL-FR-003 | Use Changesets for semantic versioning | High |
| REL-FR-004 | Create GitHub releases with changelogs | Medium |
| REL-FR-005 | Publish packages to NPM registry | High |
| REL-FR-006 | Create automatic version bump PRs | High |
| REL-FR-007 | Never cancel in-progress release workflows | High |

### Technical Requirements

| ID | Requirement | Priority |
|----|-------------|----------|
| TR-001 | Node.js 20.x runtime environment | High |
| TR-002 | pnpm 8.15.0 package manager | High |
| TR-003 | TypeScript 5.3+ compiler | High |
| TR-004 | Jest 29.x test framework | High |
| TR-005 | Turbo for build orchestration | High |
| TR-006 | Changesets for version management | High |
| TR-007 | actions/checkout@v4 | High |
| TR-008 | actions/setup-node@v4 | High |
| TR-009 | pnpm/action-setup@v4 | High |
| TR-010 | changesets/action@v1 | High |

## Architecture & Design

### Recommended Approach

1. **Two-Workflow Architecture:**
   - `ci.yml` - Runs on every PR and push, validates code quality
   - `release.yml` - Runs on main pushes, handles versioning and publishing

2. **Monorepo Tooling Stack:**
   - pnpm workspaces for dependency management
   - Turborepo for build orchestration and caching
   - Changesets for version management and changelogs

3. **Quality Gates:**
   - Build must succeed
   - TypeScript types must be valid
   - ESLint must pass
   - Tests must pass
   - npm pack must include dist/ files

### Integration Points

| Integration | Event-Forge Location | Unipile-Connector Location |
|-------------|---------------------|---------------------------|
| CI Workflow | `.github/workflows/ci.yml` | `.github/workflows/ci.yml` |
| Release Workflow | `.github/workflows/release.yml` | `.github/workflows/release.yml` |
| Changesets Config | `.changeset/config.json` | `.changeset/config.json` |
| Turbo Config | `turbo.json` | `turbo.json` |
| Package Manager | `pnpm-workspace.yaml` | `pnpm-workspace.yaml` |

### File Structure

```
.github/
└── workflows/
    ├── ci.yml              # Continuous Integration
    └── release.yml         # Release Management

.changeset/
├── config.json            # Changesets configuration
└── README.md              # Changesets documentation

turbo.json                 # Turborepo configuration
pnpm-workspace.yaml        # pnpm workspace definition
package.json               # Root package.json with scripts
```

## Implementation Guide

### Step-by-Step Plan

#### Step 1: Create Workflow Directory
```bash
mkdir -p .github/workflows
```

#### Step 2: Create CI Workflow
Create `.github/workflows/ci.yml` with:
- PR and push triggers
- Concurrency with smart cancellation
- Build, typecheck, lint, test steps
- npm pack verification for 2 packages

#### Step 3: Create Release Workflow
Create `.github/workflows/release.yml` with:
- Main branch push trigger
- Concurrency without cancellation
- Changesets action for versioning
- NPM publishing step

#### Step 4: Configure Changesets
Create `.changeset/config.json` with:
- Linked packages: `["@unipile/*"]`
- Public access
- Main branch as base

#### Step 5: Add CI Scripts to package.json
```json
{
  "scripts": {
    "build": "turbo run build",
    "lint": "turbo run lint",
    "test": "turbo run test",
    "typecheck": "turbo run typecheck",
    "changeset": "changeset",
    "version-packages": "changeset version",
    "ci:publish": "pnpm publish -r --access public --no-git-checks"
  }
}
```

#### Step 6: Configure GitHub Secrets
- Add `NPM_TOKEN` to repository secrets
- Verify GitHub Actions has required permissions

### Code Patterns

#### CI Workflow Pattern (Unipile-Connector)
```yaml
name: CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        with:
          version: 8.15.0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - run: pnpm install --frozen-lockfile
      - run: pnpm run build
      - run: pnpm run typecheck
      - run: pnpm run lint
      - run: pnpm test

      - name: Verify npm pack
        run: |
          # npm pack verification script
```

#### Release Workflow Pattern (Unipile-Connector)
```yaml
name: Release

on:
  push:
    branches:
      - main

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        with:
          version: 8.15.0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - run: pnpm install --frozen-lockfile
      - run: pnpm run build

      - name: Create Release Pull Request or Publish
        id: changesets
        uses: changesets/action@v1
        with:
          version: pnpm run version-packages
          publish: pnpm run ci:publish
          commit: 'chore(release): version packages'
          title: 'chore(release): version packages'
          createGithubReleases: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

### API References

#### GitHub Actions Used

| Action | Version | Purpose |
|--------|---------|---------|
| `actions/checkout` | v4 | Clone repository |
| `actions/setup-node` | v4 | Configure Node.js environment |
| `pnpm/action-setup` | v4 | Install pnpm |
| `changesets/action` | v1 | Version management and publishing |

#### Changesets CLI Commands

| Command | Purpose |
|---------|---------|
| `changeset` | Create new changeset |
| `changeset version` | Apply changesets to update versions |
| `changeset publish` | Publish changed packages |

## Dependencies

### Required Packages

| Package | Version | Purpose |
|---------|---------|---------|
| `@changesets/cli` | ^2.27.0 | Version management |
| `turbo` | ^2.0.0 | Build orchestration |
| `typescript` | ^5.3.0 | Type checking |
| `eslint` | ^8.56.0 | Code linting |
| `jest` | ^29.7.0 | Testing |

### Environment Variables

| Variable | Source | Purpose |
|----------|--------|---------|
| `GITHUB_TOKEN` | Automatic | GitHub API access |
| `NPM_TOKEN` | Secret | NPM registry authentication |
| `NODE_AUTH_TOKEN` | From NPM_TOKEN | Node auth for npm publish |

### Configuration Changes

| File | Change Required |
|------|-----------------|
| `package.json` | Add CI scripts |
| `.gitignore` | Add Turbo cache patterns |
| `.npmrc` | Configure registry (if needed) |

## Risks & Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| NPM_TOKEN secret not configured | Medium | High | Document setup process, verify before first release |
| Package name conflicts on NPM | Low | High | Verify `@unipile/*` availability before publishing |
| Build failures on first release | Medium | Medium | Test locally with `pnpm run ci:publish --dry-run` |
| Changesets misconfiguration | Low | Medium | Test with empty changeset, verify linked config |
| Cache invalidation issues | Low | Low | Clear Turbo cache if builds fail unexpectedly |
| Workflow permissions insufficient | Medium | Medium | Verify repository settings allow workflow writes |

## Acceptance Criteria

### CI Workflow Acceptance Criteria

- [ ] Pull request creation triggers CI workflow
- [ ] Push to main triggers CI workflow
- [ ] Build completes successfully for all packages
- [ ] TypeScript type check passes
- [ ] ESLint passes with no errors
- [ ] All tests pass
- [ ] npm pack verification confirms dist/ files included
- [ ] Concurrent PR runs are cancelled correctly
- [ ] Main branch runs are never cancelled

### Release Workflow Acceptance Criteria

- [ ] Main branch push triggers release workflow
- [ ] Adding changeset file creates version PR
- [ ] Merging version PR publishes packages to NPM
- [ ] GitHub release is created with changelog
- [ ] Package versions are synchronized across workspace
- [ ] NPM packages are publicly accessible
- [ ] Release workflow never cancels mid-run

### Configuration Acceptance Criteria

- [ ] pnpm workspace resolves all dependencies correctly
- [ ] Turbo caches builds and restores correctly
- [ ] Changesets linked packages version together
- [ ] NPM_TOKEN secret is configured and working
- [ ] Repository has required GitHub Actions permissions

## Reference Files

### Event-Forge Source Files

| File | Path |
|------|------|
| CI Workflow | `/Users/oleksii/Projects/Node/CallAiris/Event-Forge/.github/workflows/ci.yml` |
| Release Workflow | `/Users/oleksii/Projects/Node/CallAiris/Event-Forge/.github/workflows/release.yml` |
| Changesets Config | `/Users/oleksii/Projects/Node/CallAiris/Event-Forge/.changeset/config.json` |
| Turbo Config | `/Users/oleksii/Projects/Node/CallAiris/Event-Forge/turbo.json` |
| Root Package | `/Users/oleksii/Projects/Node/CallAiris/Event-Forge/package.json` |
| TypeScript Config | `/Users/oleksii/Projects/Node/CallAiris/Event-Forge/tsconfig.base.json` |
| Jest Config | `/Users/oleksii/Projects/Node/CallAiris/Event-Forge/jest.config.base.js` |
| Gitignore | `/Users/oleksii/Projects/Node/CallAiris/Event-Forge/.gitignore` |

---

*This Knowledge Base was generated by R&D Researcher and should be referenced during implementation.*
